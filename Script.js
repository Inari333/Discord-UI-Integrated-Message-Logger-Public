function l(e, n) { _enableObserver = false; e.before(n); _enableObserver = true } function s(e, n) { _enableObserver = false; e.appendChild(n); _enableObserver = true } function o(e) { _enableObserver = false; e.remove(); _enableObserver = true } function r(e) { return [...e.childNodes].filter(e => e.nodeType === Node.TEXT_NODE || !(e.nodeType === Node.ELEMENT_NODE && e.className.includes("timestamp"))).map(e => e.textContent).join("").trim() } chrome.runtime.onMessage.addListener((e, n, t) => { if (e.type === "GET_TOTAL_LOG_COUNT") { t({ count: p() }) } }); function n() { var e = document.querySelectorAll('[id^="message-content"]:not([id^="message-content-Uploader"]):not([class*="repliedTextContent"]):not(.isDeleted)'); return e } function i(n) { if (n == null || n == undefined) return null; var t = null; var e = document.querySelectorAll('ol[class*="scrollerInner"] li:not([id^="deleted-"]) time'); e.forEach(e => { if (new Date(e.getAttribute("datetime")) < u(n)) t = e.closest("li") }); if (t == null) console.log("Message Logger : No element after date found."); return t } function u(e) { var n = e.querySelector("time"); if (n == null) { console.log("Message Logger : No time element found.", e); return null } if (n.getAttribute("datetime") == null) { console.log("Message Logger : No datetime attribute found.", e); return null } return new Date(n.getAttribute("datetime")) } function a(e) { return e.matches('[class*="chat"]') ? e : e.querySelector('[class*="chat"]') } function t() { return document.querySelector('div[class*="page"] div[class*="scroller"]') } function f(e) { if (e == null) return; return e.querySelector('[id^="message-content"][class*="isSending"]') != null } function d(e) { if (_[E].t[e.id] == null || _[E].t[e.id] == undefined) return false; return _[E].t[e.id].o.length > 0 && !f(_[E].t[e.id].element) } function c(e, n) { return e.i != n && e.l != n } function S(e) { return e.closest('[class*="repliedMessage"]') != null } function G(e) { return e.closest('[aria-describedby*="message-reply"]') != null } function v(e, n) { if (e == null || e == undefined || e.element == null || e.element == undefined) return false; return e.u >= n } var g = 0; var m; var b; var w; function e() { if (E != window.location.pathname) { B = E; E = window.location.pathname; g = 0; if (_[E] == undefined) _[E] = { t: {}, v: [] } } } function M() { L(); var e = n(); e.forEach(e => { var n = r(e); var t = _[E].t[e.id]; if (t == undefined) { h(e, n) } else { t.g = false; if (c(t, n)) { t.l = n; t.o.push(n) } k(e, n) } }); y(); I() } function L() { m = z(); b = U(); w = j(); var e = _[E].t; var n = _[E].v; for (var t = m.m; t <= m.M; t++)e[n[t]].g = true } function h(e, n) { if (p() >= 10 * 5 * 10) return; _[E].t[e.id] = { i: n, l: "", o: [], g: false, element: null, u: null }; var t = F(e); console.log("Message Logger : Inserting new content at index " + t); _[E].v.splice(t, 0, e.id); x(e) } function I() { var e = _[E].v.length; if (e != g) { g = e; console.log("Message Logger : Current page log count : " + g) } } function p() { return Object.values(_).reduce((e, n) => e + n.v.length, 0) } function k(r, e) { if (d(r)) { var n = "saved-" + r.id; var o = document.getElementById(n); var t = _[E].t[r.id]; if (c(t, e) || o == null) { if (o == null) { o = document.createElement("div"); o.id = n; o.className = r.className; l(r, o); r.style.display = "none" } else o.replaceChildren(); N(r, o, t.i, " (original)"); var i = _[E].t[r.id].o; i.forEach((e, n) => { if (i.length == 1) N(r, o, e, " (edited)"); else { var t = n + 1; N(r, o, e, " (edited " + t + ")") } }); x(r) } } } function x(e) { if (e.closest("li") == null) { console.log("Message Logger :  Cant save element"); console.log(e); _[E].t[e.id].element = null; _[E].t[e.id].u = null; return } var n = e.closest("li").cloneNode(true); _[E].t[e.id].element = n; _[E].t[e.id].element.id = "deleted-" + _[E].t[e.id].element.id; _[E].t[e.id].element.querySelectorAll('[id^="message-content"]').forEach(e => { e.classList.add("isDeleted") }); _[E].t[e.id].u = u(n); O(_[E].t[e.id].element) } function y() { var e = document.querySelector('ol[class*="scrollerInner"]'); if (e == null) return; for (var n = m.m; n <= m.M; n++) { var t = _[E].v[n]; if (_[E].t[t].element == null || _[E].t[t].element == undefined) { console.log("Message Logger : Can't display deleted content of element null"); return } if (_[E].t[t].g && document.getElementById(_[E].t[t].element.id) == null && !f(_[E].t[t].element) && v(_[E].t[t], b)) { var r = i(_[E].t[t].element); if (r != null) s(r, _[E].t[t].element) } else if (!_[E].t[t].g && document.getElementById(_[E].t[t].element.id) != null) o(_[E].t[t].element) } } function N(e, n, t, r) { var o = e.querySelector('span[class*="edited"]'); if (o == null) return; var i = document.createElement("div"); i.textContent = t; if (r != null) { var l = document.createElement("span"); l.className = o.className; l.style.color = "var(--text-muted)"; l.textContent = r; s(i, l) } s(n, i) } function O(e) { } function U() { var e = document.querySelector('ol[class*="scrollerInner"] li:not([id^="deleted-"]) time'); if (e == null) { console.log("Message Logger : Couldn't find start time element"); return null } if (!e.hasAttribute("datetime")) { console.log("Message Logger : start time element does not contain attribute datetime"); return null } return new Date(e.getAttribute("datetime")) } function j() { var e = t(); if (!q(e)) { var n = document.querySelector('ol[class*="scrollerInner"] li:not([id^="deleted-"]):last-of-type time'); if (n == null) { console.log("Message Logger : Couldn't find end time element"); return null } if (!n.hasAttribute("datetime")) { console.log("Message Logger : end time element does not contain attribute datetime", n); return null } return new Date(n.getAttribute("datetime")) } return null } function q(e, n = 50) { if (e == null || e == undefined) return true; return e.scrollHeight - e.scrollTop - e.clientHeight <= n } function z() { var e = _[E].v; var n = _[E].t; if (!e || e.length === 0) { return { m: 0, M: -1 } } var t = 0; var r = e.length; while (t < r) { const l = t + r >> 1; const s = n[e[l]]; if (!s || s.u === null) { console.log("Message Logger : content date at index " + l + " is null. Return previous binary search itineration."); break } if (s.u < b) t = l + 1; else r = l } const o = t; var i = e.length - 1; if (w != null) { t = o; r = e.length; while (t < r) { const l = t + r >> 1; const s = n[e[l]]; if (!s || s.u == null) console.log("Message Logger : content date at index " + l + " is null. Return previous binary search itineration."); break; if (s.u <= w) t = l + 1; else r = l } i = t - 1 } console.log("Message Logger : Index for date " + b + " to " + w + " is " + t + " and " + (e.length - 1)); return { m: o, M: i } } function F(e) { var n = e.closest("li"); var t = new Date(u(n)); var r = _[E].v; var o = _[E].t; if (!r || r.length === 0) { return 0 } var i = 0; var l = r.length; while (i < l) { const s = i + l >> 1; const a = o[r[s]]; if (!a || a.u === null) { console.log("Message Logger : content date at index " + s + " is null. Return previous binary search itineration."); break } if (a.u < t) i = s + 1; else l = s } return i } function H(e, n) { if (!e) { console.error("Test assertion failed: " + (n || "Assertion failed")); return false } console.error("Test assertion succeeded: " + (n || "Assertion succeeded")); return true } function J(e) { var n = e || E; if (typeof _ === "undefined" || !_[n]) { return { ok: false, message: 'No saved contents for path "' + n + '"' } } var t = _[n]; var r = t.v; var o = t.t; if (!r || r.length <= 1) { return { ok: true, message: "Trivially sorted (0 or 1 element)" } } for (var i = 1; i < r.length; i++) { var l = o[r[i - 1]]; var s = o[r[i]]; if (!l) return { ok: false, message: "Missing contentsById for id: " + r[i - 1] }; if (!s) return { ok: false, message: "Missing contentsById for id: " + r[i] }; if (!l.u) return { ok: false, message: "Null/undefined date for id: " + r[i - 1] }; if (!s.u) return { ok: false, message: "Null/undefined date for id: " + r[i] }; var a = new Date(l.u); var u = new Date(s.u); if (isNaN(a.getTime())) return { ok: false, message: "Invalid date for id: " + r[i - 1] }; if (isNaN(u.getTime())) return { ok: false, message: "Invalid date for id: " + r[i] }; if (a.getTime() > u.getTime()) { var f = "Order incorrect at index " + (i - 1) + " -> " + i + ": " + r[i - 1] + " (" + a + ") should be <= " + r[i] + " (" + u + ")"; console.error("ContentIds sorting test failed: " + f); return { ok: false, message: f } } } console.log('ContentIds sorting test passed for path "' + n + '"'); return { ok: true, message: "Sorted" } } function K(e) { var n = J(e); if (!n.ok) throw new Error("ContentIds sorting assertion failed: " + n.message); return n } var P = 100; var Q = 500; var V = 500; var W = false; var C = true; var D = null; var T = null; var _ = []; var E = null; var B = null; A(); function A() { window.addEventListener("beforeunload", R); const e = Math.random().toString(36).slice(5); console.log("Message Logger : Script has started. Instance ID " + e); Z() } function R() { window.removeEventListener("beforeunload", R); if (D != null) { D.disconnect(); D = null } if (T != null) { T.disconnect(); T = null } _ = []; E = null; B = null } function X() { R(); A() } function Y() { e(); M() } function Z() { D = new MutationObserver(e => { for (const n of e) { if (n.type !== "childList") continue; $(n); ee(n) } }); D.observe(document.body, { childList: true, subtree: true }) } function $(e) { if (!T) return; for (const t of e.removedNodes) { if (!(t instanceof Element)) continue; var n = a(t); if (n) { if (T) { T.disconnect(); T = null; console.log("Message Logger : Chat was removed") } } } } function ee(e) { if (T) return; for (const t of e.addedNodes) { if (!(t instanceof Element)) continue; var n = a(t); if (n) { ne(n); return } } } function ne(e) { if (T) return; console.log("Message Logger : Chat found"); T = new MutationObserver(te(Y)); T.observe(e, { childList: true, subtree: true }) } function te(t) { let r; return (...e) => { clearTimeout(r); const n = C ? P : Q; r = setTimeout(() => { t(...e); C = true }, n) } }