function e(e,n){_enableObserver=!1,e.before(n),_enableObserver=!0}function n(e,n){_enableObserver=!1,e.appendChild(n),_enableObserver=!0}function t(e){_enableObserver=!1,e.remove(),_enableObserver=!0}function l(e){return[...e.childNodes].filter(e=>e.nodeType===Node.TEXT_NODE||!(e.nodeType===Node.ELEMENT_NODE&&e.className.includes("timestamp"))).map(e=>e.textContent).join("").trim()}const o="https://inari-discord-api-emhndjbwfqc4enfz.canadaeast-01.azurewebsites.net",r=Object.freeze({FREE:0,BASIC:1,PREMIUM:2});async function i(e,n){const t=await chrome.runtime.sendMessage({type:"PAY_FROM_DISCORD_MESSAGE_LOGGER",planLevel:e,key:me});t?.success?window.open(t.url,"_blank"):n&&n()}async function s(e,n){const t=await chrome.runtime.sendMessage({type:"KEY_CHECK_FROM_DISCORD_MESSAGE_LOGGER",key:e});return t?.success?t.level:(n&&n(),0)}function c(e){if(null!=e)return null!=e.querySelector('[id^="message-content"][class*="isSending"]')}function d(e){return null!=de[ae].contentsById[e.id]&&null!=de[ae].contentsById[e.id]&&(de[ae].contentsById[e.id].allEdit.length>0&&!c(de[ae].contentsById[e.id].element))}function a(e,n){return e.original!=n&&e.lastEdit!=n}function u(e){return null!=e.closest('[class*="repliedMessage"]')}function f(e){return null!=e.closest('[aria-describedby*="message-reply"]')}function m(e,n){return null!=e&&null!=e&&null!=e.element&&null!=e.element&&e.date>=n}function y(){return document.querySelectorAll('[id^="message-content"]:not([id^="message-content-Uploader"]):not([class*="repliedTextContent"]):not(.isDeleted)')}function I(e){if(null==e||null==e)return null;var n=null;return document.querySelectorAll('ol[class*="scrollerInner"] li:not([id^="deleted-"]) time').forEach(t=>{new Date(t.getAttribute("datetime"))<v(e)&&(n=t.closest("li"))}),n}function v(e){var n=e.querySelector("time");return null==n||null==n.getAttribute("datetime")?null:new Date(n.getAttribute("datetime"))}function h(e){return e.matches('[class*="chat"]')?e:e.querySelector('[class*="chat"]')}function g(){return document.querySelector('div[class*="page"] div[class*="scroller"]')}var b,B,E,p=0;function w(){ae!=window.location.pathname&&(ue=ae,ae=window.location.pathname,p=0,null==de[ae]&&(de[ae]={contentsById:{},contentIdsByIndex:[]}))}function x(){M(),y().forEach(e=>{var n=l(e),t=de[ae].contentsById[e.id];null==t?S(e,n):(t.isDeleted=!1,a(t,n)&&(t.lastEdit=n,t.allEdit.push(n)),_(e,n))}),L(),P(),O()}function M(){b=R(),B=k(),E=T();for(var e=de[ae].contentsById,n=de[ae].contentIdsByIndex,t=b.leftIndex;t<=b.rightIndex;t++)e[n[t]].isDeleted=!0}function S(e,n){if(fe=D(),!(-1!=ee[$]&&fe>=ee[$])){de[ae].contentsById[e.id]={original:n,lastEdit:"",allEdit:[],isDeleted:!1,element:null,date:null};var t=G(e);de[ae].contentIdsByIndex.splice(t,0,e.id),A(e),oe=!0}}function O(){var e=de[ae].contentIdsByIndex.length;e!=p&&(p=e)}function D(){return Object.values(de).reduce((e,n)=>e+n.contentIdsByIndex.length,0)}function _(n,t){if(d(n)){var l="saved-"+n.id,o=document.getElementById(l),r=de[ae].contentsById[n.id];if(a(r,t)||null==o){null==o?((o=document.createElement("div")).id=l,o.className=n.className,e(n,o),n.style.display="none"):o.replaceChildren(),C(n,o,r.original," (original)");var i=de[ae].contentsById[n.id].allEdit;i.forEach((e,t)=>{1==i.length?C(n,o,e," (edited)"):C(n,o,e," (edited "+(t+1)+")")}),A(n)}}}function A(e){if(null==e.closest("li"))return de[ae].contentsById[e.id].element=null,void(de[ae].contentsById[e.id].date=null);var n=e.closest("li").cloneNode(!0);de[ae].contentsById[e.id].element=n,de[ae].contentsById[e.id].element.id="deleted-"+de[ae].contentsById[e.id].element.id,de[ae].contentsById[e.id].element.querySelectorAll('[id^="message-content"]').forEach(e=>{e.classList.add("isDeleted")}),de[ae].contentsById[e.id].date=v(n),N(de[ae].contentsById[e.id].element)}function L(){if(null!=document.querySelector('ol[class*="scrollerInner"]'))for(var e=b.leftIndex;e<=b.rightIndex;e++){var l=de[ae].contentIdsByIndex[e];if(null!=de[ae].contentsById[l].element&&null!=de[ae].contentsById[l].element)if(de[ae].contentsById[l].isDeleted&&null==document.getElementById(de[ae].contentsById[l].element.id)&&!c(de[ae].contentsById[l].element)&&m(de[ae].contentsById[l],B)){var o=I(de[ae].contentsById[l].element);null!=o&&n(o,de[ae].contentsById[l].element)}else de[ae].contentsById[l].isDeleted||null==document.getElementById(de[ae].contentsById[l].element.id)||t(de[ae].contentsById[l].element)}}function C(e,t,l,o){var r=e.querySelector('span[class*="edited"]');if(null!=r){var i=document.createElement("div");if(i.textContent=l,null!=o){var s=document.createElement("span");s.className=r.className,s.style.color="var(--text-muted)",s.textContent=o,n(i,s)}n(t,i)}}function N(){}function k(){var e=document.querySelector('ol[class*="scrollerInner"] li:not([id^="deleted-"]) time');return null==e?null:e.hasAttribute("datetime")?new Date(e.getAttribute("datetime")):null}function T(){if(!q(g())){var e=document.querySelector('ol[class*="scrollerInner"] li:not([id^="deleted-"]):last-of-type time');return null==e?null:e.hasAttribute("datetime")?new Date(e.getAttribute("datetime")):null}return null}function q(e,n=50){return null==e||null==e||e.scrollHeight-e.scrollTop-e.clientHeight<=n}function R(){var e=de[ae].contentIdsByIndex,n=de[ae].contentsById;if(!e||0===e.length)return{leftIndex:0,rightIndex:-1};for(var t=0,l=e.length;t<l;){const o=t+l>>1,r=n[e[o]];if(!r||null===r.date)break;r.date<B?t=o+1:l=o}const o=t;var r=e.length-1;if(null!=E){for(t=o,l=e.length;t<l;){const o=t+l>>1,r=n[e[o]];if(!r||null==r.date)break;r.date<=E?t=o+1:l=o}r=t-1}return{leftIndex:o,rightIndex:r}}function G(e){var n=e.closest("li"),t=new Date(v(n)),l=de[ae].contentIdsByIndex,o=de[ae].contentsById;if(!l||0===l.length)return 0;for(var r=0,i=l.length;r<i;){const e=r+i>>1,n=o[l[e]];if(!n||null===n.date)break;n.date<t?r=e+1:i=e}return r}chrome.runtime.onMessage.addListener((e,n,t)=>{if("DELETE_ALL_LOGS"===e.type)J(),t({success:!0})});const j=()=>new Promise(e=>setTimeout(e,0));async function H(e){await j();const n=se.encode(e),t=Q?pako.deflateRaw(n,{level:X}):pako.deflate(n,{level:X});let l="";for(let e=0;e<t.length;e+=32768)await j(),l+=String.fromCharCode(...t.subarray(e,e+32768));return btoa(l)}function z(e){const n=atob(e),t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);const l=Q?pako.inflateRaw(t):pako.inflate(t);return ce.decode(l)}async function F(){performance.now();const e=de[ae];if(!e)return;const n=JSON.stringify(e,(e,n)=>"element"===e&&n?n.outerHTML:n);if(ie=n,!re){re=V;const e=await H(n),t=`logs-${ae}`;Z.set({[t]:e},()=>{re=!1,ie!==n&&F()})}}function P(){oe&&(oe=!1,F(),K(fe))}function U(e){Z.get(null,n=>{for(const e in n)if(e.startsWith("logs-")){const t=e.substring(5),l=z(n[e]);de[t]=JSON.parse(l,(e,n)=>{if("element"===e&&"string"==typeof n){const e=document.createElement("div");return e.innerHTML=n,e.firstChild}return"date"===e&&"string"==typeof n?new Date(n):n})}e&&e()})}function J(){de={},ae=null,w(),Z.get(null,e=>{const n=Object.keys(e).filter(e=>e.startsWith("logs-"));Z.remove(n,()=>{K(0)})})}function K(e){Z.set({logsCount:e})}var W=100,Y=500,X=6,Q=!0,V=!1;const Z=("undefined"!=typeof browser?browser:chrome).storage.local;var $=0;const ee=[Math.round(Math.pow(22.36,2)),Math.round(Math.pow(44.72,2)),-1*Math.round(Math.pow(1,3))];var ne=!0,te=null,le=null,oe=!1,re=!1,ie=null;const se=new TextEncoder,ce=new TextDecoder;var de={},ae=null,ue=null,fe=0,me=null;async function ye(){await Ie(),window.addEventListener("beforeunload",ve),U(()=>{be()})}async function Ie(){const e=await Z.get(["key"]);e.key?me=e.key:(me=Array.from({length:10},()=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[Math.floor(62*Math.random())]).join(""),await Z.set({key:me})),$=await s(me)}function ve(){P(),window.removeEventListener("beforeunload",ve),null!=te&&(te.disconnect(),te=null),null!=le&&(le.disconnect(),le=null),de={},ae=null,ue=null,oe=!1,fe=0,me=null}function he(){ve(),ye()}function ge(){w(),x()}function be(){(te=new MutationObserver(e=>{for(const n of e)"childList"===n.type&&(Be(n),Ee(n))})).observe(document.body,{childList:!0,subtree:!0})}function Be(e){if(le)for(const n of e.removedNodes){if(n instanceof Element)h(n)&&le&&(le.disconnect(),le=null)}}function Ee(e){if(!le)for(const t of e.addedNodes)if(t instanceof Element){var n=h(t);if(n)return void pe(n)}}function pe(e){le||(le=new MutationObserver(we(ge))).observe(e,{childList:!0,subtree:!0})}function we(e){let n;return(...t)=>{clearTimeout(n);n=setTimeout(()=>{e(...t),ne=!0},ne?W:Y)}}ye();